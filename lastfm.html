<!DOCTYPE html>
<html lang="en">

		<head>
				<meta charset="utf-8">
				<title>Last.fm: Testing the JSON</title>
				<!--<<script src="d3/d3.v3.js" charset="utf-8"></script>-->
				<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
				<script src="http://d3js.org/queue.v1.min.js"></script>
				<link href='http://fonts.googleapis.com/css?family=Lato:100,100italic,300,300italic' rel='stylesheet' type='text/css'>
				<link href='http://fonts.googleapis.com/css?family=Raleway:400,200' rel='stylesheet' type='text/css'>


		</head>
<style>

.blurb {
	padding: 8px;
	margin: 20px;
}

.blurb h3 {
	font: 400 30px 'Raleway', sans-serif;
}

.blurb p {
	font: 300 14px 'Lato', sans-serif;
	width: 200px;

}

form input {
  font: 100 24px "Lato", sans-serif;
  padding: 2px 8px;
  border: solid 1px #ccc;
  border-radius: 10px;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);
  margin: 5px;
}

form {
  border: none;
  font: 100 24px "Lato", sans-serif;
  padding: 20px 30px;
}

#userName {
	width: 200px;
}

#topNumber {
	width: 60px;
}

.update-button:hover {
	background-color: #999;
	cursor: pointer;
}

.update-button:active {
	background-color: #666;
}

</style>

<body>

	<div class="blurb">
	<h3>A pretty way to visualize your listening habits</h3>
	<p>Courtesy of the <a href="http://www.last.fm/api" target="_blank">last.fm API</a>.</p> 
	<p>Use your <a href="http://last.fm" target="_blank">last.fm</a> username. Or your friend's. Or the demo user, <em>rj</em>.</p>
</div>

		<div class="user-inputs">
			<form>
			What's your username? <input type="text" name="userName" id="userName" placeholder="rj"><br>
			How many artists do you want to see? <input type="text" id="topNumber" placeholder="1-500"></br>
			<input name="updateButton" 
           type="button" 
           class="update-button"
           value="Update" />
			</form>
		</div>


<script>

"use strict";

var w = 600,
	h = 300,
	radius = Math.min(w, h) / 2,
	cwidth = 50,
	color = d3.scale.category20c();

var svg = d3.select("body")
	.append("svg")
	.attr("width", w)
	.attr("height", h)
	.append("g")
	.attr("transform", "translate(" + w/2 + "," + h/2 + ")");


d3.select('input[type=button]').on('click', function() {
  
  var userText = document.getElementById('userName').value,
  	  userNumber = document.getElementById('topNumber').value,
      topArtists, 
      artistTag,
      dataset;

   //Change this from an alert() to a tooltip that only displays when wrong.
   if (isNaN(userNumber)) { alert("Please enter a number."); }; 

  var top = 'http://ws.audioscrobbler.com/2.0/?method=user.gettopartists&user=' + userText + '&api_key=07eef8055a0b408f70b1b3d5039bbaf5&format=json&period=12month&limit=' + userNumber;

  var tags = 'http://ws.audioscrobbler.com/2.0/?method=artist.gettoptags&mbid=164f0d73-1234-4e2c-8743-d77bf2191051&api_key=07eef8055a0b408f70b1b3d5039bbaf5&format=json';


	//First JSON call
	d3.json(top, function(error, json) {

	    if(error) { return console.log(error); } 

		topArtists = json.topartists.artist; 

		
		//Merge, using  a dynamic .queue() call

		var q = queue()
			.defer(d3.json, top);

		topArtists.forEach(function(d) { 

				tags = 'http://ws.audioscrobbler.com/2.0/?method=artist.gettoptags&mbid='+ d.mbid + '&api_key=07eef8055a0b408f70b1b3d5039bbaf5&format=json'

				q.defer(d3.json, tags);
			
				});

		q.awaitAll(function() {	


				//DATA
				//Setting up the dataset (merging, cleaning)

				dataset = arguments[1][0].topartists.artist
				
				for (var i = 1; i < arguments[1].length ; i++) {	

					var j = i - 1;

					if (!arguments[1][i].toptags || !arguments[1][i].toptags.tag || !arguments[1][i].toptags.tag[0]) { 

						dataset[j]["tag"] = "none"; 

					} else {

					var artistName = arguments[1][0].topartists.artist[j].name;
					var artistTagName = arguments[1][i].toptags['@attr'].artist;

						if ( artistName == artistTagName ) {

							artistTag = arguments[1][i].toptags.tag[0].name.toLowerCase().split('-').join(' ');

							dataset[j]["tag"] = artistTag;

						}; //name check conditional if statement

					}; // if tags exist

				}; //close for loop (adding tags to dataset)


				//Destring playcount
				dataset.forEach(function(d) {
					d.playcount = +d.playcount;
				});
			
				//Organizing data by genre/tag
				dataset = d3.nest()
					.key(function(d) { return d.tag; })
					.sortValues(function(a, b) { return parseFloat(b.playcount) - parseFloat(a.playcount); })
					.entries(dataset);


				//VISUALIZATION

				//Attempting inner/outer rings.

				var arc = d3.svg.arc()
					.outerRadius(radius - 10)
					.innerRadius(radius - 70);

				var pie = d3.layout.pie()
					.sort(null)
					.value(function(d) { 
						var sum = 0;
						for (i=0 ; i<d.values.length ; i++) {
							sum += d.values[i].playcount;
						}
						return sum;
					});

				console.log(pie(dataset));

				var genres = svg.selectAll("g")
					.data(d3.values(dataset));

				genres.enter()
					.append("g");

				var path = genres.selectAll("path")
					.data(pie(dataset));

				path.enter()
					.append("path")
					.attr("fill", function(d, i) { return color(i); })
					.style("stroke-width", "1px")
					.style("stroke", "white")
					.attr("d", arc);

				genres.exit().remove();

				path.exit().remove();

			




/*
				var pie = d3.layout.pie()
					.sort(null)
					.value(function(d) { 
						var sum = 0;
						for (i=0 ; i<d.values.length ; i++) {
							sum += d.values[i].playcount;
						}
						return sum;
					});



				var g = svg.selectAll(".arc")
					.data(pie(dataset))
					.enter()
					.append("g")
					.attr("class", "arc");


				g.append("path")
					.attr("d", arc)
					.style("stroke-width", "1px")
					.style("stroke", "white")
					.style("fill", function(d) { 
						return color(d.data.key); 
					});
*/

			}); //queue.awaitAll() closer

  }); //topArtists json call closer

}); //on click function closer


</script>
</body>
</html>