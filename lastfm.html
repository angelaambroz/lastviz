<!DOCTYPE html>
<html lang="en">

		<head>
				<meta charset="utf-8">
				<title>Last.fm: Testing the JSON</title>
				<!--<<script src="d3/d3.v3.js" charset="utf-8"></script>-->
				<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
				<script src="http://d3js.org/queue.v1.min.js"></script>


		</head>
<style>
/* To do. */
</style>

<body>


			<form>
			Username: <input type="text" name="userName" id="userName"><br><br>
			<input name="updateButton" 
           type="button" 
           value="Update" />
			</form>


<script>

"use strict";

var w = 300,
	h = 300,
	outerRadius = w / 2,
	innerRadius = w / 3, 
	arc = d3.svg.arc()
			.innerRadius(innerRadius)
			.outerRadius(outerRadius),
	pie = d3.layout.pie(),
	color = d3.scale.category20b();


var svg = d3.select("body")
	.append("svg")
	.attr("width", w)
	.attr("height", h);



d3.select('input[type=button]').on('click', function() {
  
  var userText = document.getElementById('userName').value,
      topArtists, 
      artistTag,
      dataset,
      fullData;

  var top = 'http://ws.audioscrobbler.com/2.0/?method=user.gettopartists&user=' + userText + '&api_key=07eef8055a0b408f70b1b3d5039bbaf5&format=json&period=12month&limit=10';

  var tags = 'http://ws.audioscrobbler.com/2.0/?method=artist.gettoptags&mbid=164f0d73-1234-4e2c-8743-d77bf2191051&api_key=07eef8055a0b408f70b1b3d5039bbaf5&format=json';


	//First JSON call
	d3.json(top, function(error, json) {

	    if(error) { return console.log(error); } 

		topArtists = json.topartists.artist; 

		/*
		//Merge (attempted)
		topArtists.forEach(function(d) {
			//loop through each of the top 10 artists selected
			//pull their mbid (musicbrainz id) and plug it into the var for tags			
			tags = 'http://ws.audioscrobbler.com/2.0/?method=artist.gettoptags&mbid='+ d.mbid + '&api_key=07eef8055a0b408f70b1b3d5039bbaf5&format=json';

				//pull that JSON
				d3.json(tags, function(error, tag) {

					if (error) { return console.log(error); };
					
					//capture only the most commonly used tag (artistTag)
					//and also clean it up a bit
					artistTag = tag.toptags.tag[0].name.toLowerCase().split('-').join(' ');

					//push that string value to the original JSON
					d["tag"] = artistTag;

					
				}); // close tags JSON call 
			}); //close topArtists loop	

			*/

		//Merge (second attempt)

		var q = queue()
			.defer(d3.json, top);

		//topArtists = arguments[1][0].topartists.artist;

		topArtists.forEach(function(d) { 

				tags = 'http://ws.audioscrobbler.com/2.0/?method=artist.gettoptags&mbid='+ d.mbid + '&api_key=07eef8055a0b408f70b1b3d5039bbaf5&format=json'

				q.defer(d3.json, tags);
			
				});

		q.awaitAll(function() {			


				dataset = arguments[1][0].topartists.artist
				
				for (var i = 1; i < arguments[1].length ; i++) {

					var j = i - 1;

					var artistName = arguments[1][0].topartists.artist[j].name;
					var artistTagName = arguments[1][i].toptags['@attr'].artist;

					if ( artistName == artistTagName ) {

						artistTag = arguments[1][i].toptags.tag[0].name.toLowerCase().split('-').join(' ');

						dataset[j]["tag"] = artistTag;

					};

				}; //close for loop


			
				dataset = d3.nest()
					.key(function(d) {
						return d.tag; 
					})
					.entries(dataset);

				console.log(dataset);




				/*

	 		//The visualization: Sunburst

			var arcs = svg.selectAll("g.arc")
					.data(pie(topArtists))
					.enter()
					.append("g")
					.attr("class", "arc")
					.attr("transform", "translate(" + outerRadius + "," + outerRadius + ")");

			//Draw arc paths
				arcs.append("path")
				    .attr("fill", function(d, i) {
				    	return color(i);
				    })
				    .attr("d", arc);

*/

				


			}); //queue.await closer - I think I can put everything in here...

  }); //topArtists json call

}); //on click function


</script>
</body>
</html>